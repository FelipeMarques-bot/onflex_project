{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4><i class="fas fa-file-signature"></i> Nova Ordem de Serviço</h4>
        <a href="{% url 'dashboard' %}" class="btn btn-secondary btn-sm">
            <i class="fas fa-arrow-left"></i> Voltar
        </a>
    </div>

    <div class="card shadow">
        <div class="card-body">
            <form method="post" id="osForm">
                {% csrf_token %}

                <div class="mb-3">
                    <label class="form-label">Cliente</label>
                    {{ form.cliente }}
                </div>

                <div class="mb-3">
                    <label class="form-label">O que foi feito?</label>
                    {{ form.descricao_servico }}
                </div>

                <div class="mb-3">
                    <label class="form-label">Peças Utilizadas</label>
                    {{ form.pecas_usadas }}
                </div>

                <div class="mb-3">
                    <label class="form-label">KM Percorrida</label>
                    {{ form.km_percorrida }}
                </div>

                <!-- Área de Assinatura -->
                <div class="mb-4">
                    <label class="form-label fw-bold">Assinatura do Cliente</label>
                    <div style="border: 2px dashed #ccc; background: #f9f9f9; touch-action: none;">
                        <canvas id="signature-pad" width="300" height="200" style="width: 100%;"></canvas>
                    </div>
                    <button type="button" class="btn btn-sm btn-secondary mt-2" onclick="clearSignature()">Limpar Assinatura</button>
                    {{ form.assinatura_base64 }}
                </div>

                <button type="submit" class="btn btn-success w-100 btn-lg">Salvar OS</button>
            </form>
        </div>
    </div>
</div>

<script>
    var canvas = document.getElementById('signature-pad');
    var ctx = canvas.getContext('2d');
    var isDrawing = false;

    function resizeCanvas() {
        var ratio = Math.max(window.devicePixelRatio || 1, 1);
        canvas.width = canvas.offsetWidth * ratio;
        canvas.height = canvas.offsetHeight * ratio;
        ctx.scale(ratio, ratio);
    }
    window.onresize = resizeCanvas;
    resizeCanvas();

    function startDraw(e) {
        isDrawing = true;
        ctx.beginPath();
        var pos = getPos(e);
        ctx.moveTo(pos.x, pos.y);
    }

    function draw(e) {
        if (!isDrawing) return;
        var pos = getPos(e);
        ctx.lineTo(pos.x, pos.y);
        ctx.stroke();
    }

    function endDraw() {
        isDrawing = false;
        document.getElementById('id_assinatura_base64').value = canvas.toDataURL();
    }

    function getPos(e) {
        var rect = canvas.getBoundingClientRect();
        var x, y;
        if (e.touches) {
            x = e.touches[0].clientX - rect.left;
            y = e.touches[0].clientY - rect.top;
        } else {
            x = e.clientX - rect.left;
            y = e.clientY - rect.top;
        }
        return {x: x, y: y};
    }

    canvas.addEventListener('mousedown', startDraw);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', endDraw);
    canvas.addEventListener('touchstart', function(e) { e.preventDefault(); startDraw(e); });
    canvas.addEventListener('touchmove', function(e) { e.preventDefault(); draw(e); });
    canvas.addEventListener('touchend', endDraw);

    function clearSignature() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        document.getElementById('id_assinatura_base64').value = '';
    }
</script>
{% endblock %}